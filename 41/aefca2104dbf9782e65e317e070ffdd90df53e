X-Spam-Checker-Version: SpamAssassin 3.3.2 (2011-06-06) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS14383 205.234.109.0/24
X-Spam-Status: No, score=-0.6 required=5.0 tests=AWL,FREEMAIL_FROM,
 MSGID_FROM_MTA_HEADER,RP_MATCHES_RCVD,T_DKIM_INVALID shortcircuit=no
 autolearn=unavailable version=3.3.2
Path: news.gmane.org!not-for-mail
From: Justin Giancola <justin.giancola@gmail.com>
Newsgroups: gmane.comp.lang.ruby.unicorn.general
Subject: completely stumped by problem encountered replacing running unicorn
Date: Thu, 14 Oct 2010 00:58:49 -0400
Message-ID: <AANLkTinQUf-DOWk=wzxdfZTTKrKy5Kvw+xaQZrHv8Q+Z@mail.gmail.com>
NNTP-Posting-Host: lo.gmane.org
Mime-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
X-Trace: dough.gmane.org 1287032813 21792 80.91.229.12 (14 Oct 2010 05:06:53
 GMT)
X-Complaints-To: usenet@dough.gmane.org
NNTP-Posting-Date: Thu, 14 Oct 2010 05:06:53 +0000 (UTC)
To: mongrel-unicorn@rubyforge.org
Original-X-From: mongrel-unicorn-bounces@rubyforge.org Thu Oct 14 07:06:52
 2010
Return-path: <mongrel-unicorn-bounces@rubyforge.org>
Envelope-to: gclrug-mongrel-unicorn@m.gmane.org
X-Original-To: mongrel-unicorn@rubyforge.org
Delivered-To: mongrel-unicorn@rubyforge.org
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;
 h=domainkey-signature:mime-version:received:received:date:message-id
 :subject:from:to:content-type;
 bh=4F9uTx7aZEEg4ilMl38Lr3EdfeVHe2+QfA8N6nBxCR8=;
 b=LYtzx+m1Y3RGzrPt7QugyiyZihKLKobZeGs82E829Za/DQdVDyL/wL8p3oYI8aZysk
 h61gcDoAnRZHnzfPJ4Bi6kvohKYv90FEdyNIqIBP+ci4sKYJIwVgrLoh6GpxFyj7Y4HL
 H4PMR7u9ObD2RhbT3ok/Oc5dGB1E98Iis0ibU=
DomainKey-Signature: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;
 h=mime-version:date:message-id:subject:from:to:content-type;
 b=QyI/2B9nor5ssp4oLTPt39vz47Hz0jnsJfM6nNppUBzHpOWdAkIdKru/j451XQPGw2
 f1I7uLOUeIiY75UX5tLfc+XSBzuonLzOBuwlAy63S3afZIfHV5Lyt7S9QDXeOr/xmkTs
 sGQ5Qt/Yevhcn3mqdDB1PTTxngk73PlLxkWMs=
X-BeenThere: mongrel-unicorn@rubyforge.org
X-Mailman-Version: 2.1.12
Precedence: list
List-Id: <unicorn-public@bogomips.org>
List-Unsubscribe: <http://rubyforge.org/mailman/options/mongrel-unicorn>,
 <mailto:mongrel-unicorn-request@rubyforge.org?subject=unsubscribe>
List-Archive: <http://rubyforge.org/pipermail/mongrel-unicorn>
List-Post: <unicorn-public@bogomips.org>
List-Help: <mailto:mongrel-unicorn-request@rubyforge.org?subject=help>
List-Subscribe: <http://rubyforge.org/mailman/listinfo/mongrel-unicorn>,
 <mailto:mongrel-unicorn-request@rubyforge.org?subject=subscribe>
Original-Sender: mongrel-unicorn-bounces@rubyforge.org
Errors-To: mongrel-unicorn-bounces@rubyforge.org
Xref: news.gmane.org gmane.comp.lang.ruby.unicorn.general:729
Archived-At:
 <http://permalink.gmane.org/gmane.comp.lang.ruby.unicorn.general/729>
Received: from rubyforge.org ([205.234.109.19]) by lo.gmane.org with esmtp
 (Exim 4.69) (envelope-from <mongrel-unicorn-bounces@rubyforge.org>) id
 1P6G1d-0007EL-RC for gclrug-mongrel-unicorn@m.gmane.org; Thu, 14 Oct 2010
 07:06:46 +0200
Received: from rubyforge.org (rubyforge.org [127.0.0.1]) by rubyforge.org
 (Postfix) with ESMTP id 4E60519782F8; Thu, 14 Oct 2010 01:06:44 -0400 (EDT)
Received: from mail-ww0-f54.google.com (mail-ww0-f54.google.com
 [74.125.82.54]) by rubyforge.org (Postfix) with ESMTP id 0CD3919782F8 for
 <mongrel-unicorn@rubyforge.org>; Thu, 14 Oct 2010 00:58:49 -0400 (EDT)
Received: by wwi17 with SMTP id 17so246608wwi.23 for
 <mongrel-unicorn@rubyforge.org>; Wed, 13 Oct 2010 21:58:49 -0700 (PDT)
Received: by 10.216.11.131 with SMTP id 3mr880016wex.92.1287032329411; Wed,
 13 Oct 2010 21:58:49 -0700 (PDT)
Received: by 10.216.70.213 with HTTP; Wed, 13 Oct 2010 21:58:49 -0700 (PDT)

Hello,

First off, many thanks to all those who have contributed to this great
project. I have been running Unicorn in production for quite some time
now. It hass been very reliable and I have really enjoyed being able
to deploy frequently without downtime or even dropped connections.

I have used the USR2+QUIT upgrade procedure as described in SIGNALS
since I started using Unicorn and it works great. However, while
upgrading Bundler on my server the other day, an upgrade failed for
the first time. The upgrade failed due to a LoadError -- <application
root>/gems/environment.rb is no longer used in Bundler 1.0 so it was
missing from the new application tree.

I am using a Capistrano setup so my app is located at
/path/to/app/current where current is a symlink to a timestamped
release directory. I am calling #working_directory in my unicorn
config to set it to the symlinked current path. I am also calling
unicorn via a binstub generated by Bundler located at
/path/to/app/current/bin/unicorn.

I had expected that reexec would pick up the new unicorn and app code
because the path to the unicorn executable script, the path to my app,
and config files were all identical to those used in the previous
deploy. However, this is not what is happening. Rather, it looks like
the previous version of the code is trying to reload iteself in the
new app tree where files are missing.

I am having a very difficult time understanding exactly what files are
being reloaded during the reexec. Even my attempts at troubleshooting
where the load error is originating have left me completely baffled.
In the old app gems/environment.rb is required in a few places but
none of those files seem to be reloaded during the reexec. Further, I
cannot get this executable swap to work no matter what I try. I have
even tried getting rid of the symlinks entirely and changing the
contents of the /path/to/app/current in place during the upgrade.

I feel like I may be missing something obvious or else I have
completely misunderstood how the reload process works. Any insight as
to what I should be doing differently would be greatly appreciated.


Justin
_______________________________________________
Unicorn mailing list - mongrel-unicorn@rubyforge.org
http://rubyforge.org/mailman/listinfo/mongrel-unicorn
Do not quote signatures (like this one) or top post when replying

